# API 通知系统

本仓库为作业提交，目标是设计并实现一个对内统一、对外可靠投递的 API 通知系统。以下内容覆盖题目要求的理解、设计、取舍与 AI 使用说明。

开发日志见：[wiki/dev_log.md](wiki/dev_log.md)

## 1. 问题理解
企业内部多个业务系统在关键事件发生时需要调用外部供应商的 HTTP(S) API 通知。供应商 API 在地址、请求头、请求体上各不相同。业务系统不关心返回值，但需要通知请求“尽可能可靠”送达。

核心诉求：
- 对内提供统一、标准化的 HTTP API。
- 系统负责可靠投递，业务系统无需处理外部失败。

## 2. 系统边界（解决与不解决）
解决：
- 统一接入：对内单一 API 入口，接收目标地址、请求头、请求体、方法等。
- 可靠投递：至少一次投递语义，失败重试与状态记录。
- 可观测：记录投递结果、失败原因、重试次数，便于排障与补偿。

不解决（第一版明确不做）：
- 供应商协议适配/编排（如协议转换、复杂模板渲染）：差异大且方案复杂，MVP 先不做以控制复杂度。
- 对外 API 返回值的业务语义处理：业务方不关心返回值，第一版仅记录结果即可。
- 精确一次投递：需要分布式事务或复杂幂等协作，复杂度高且收益有限。
- 可视化管理后台与 SLA 管理：属于运营能力建设，非 MVP 交付必要。

## 3. 核心设计与架构
### 3.1 组件
- API 接入层：接收通知请求、做基础校验、写入存储、入队。
- 持久化存储：记录通知任务、投递状态、重试信息、最后错误。
- 任务队列：解耦接入与投递，提升可靠性与吞吐。
- 投递执行器：按策略重试调用外部 API。

### 3.2 数据模型（示意）
- Notification(id, target_url, method, headers, body, status, attempts, next_retry_at, last_error, created_at, updated_at)

### 3.3 对内 API（示意）
POST /notifications
- 请求体：{ target_url, method, headers, body, timeout_ms, idempotency_key? }
- 响应体：{ id, accepted_at }

说明：对内返回“已接收”，不等待外部调用结果。

## 4. 可靠性与失败处理
投递语义：至少一次。

策略：
- 初次投递失败进入重试队列。
- 指数退避 + 抖动：例如 1m/5m/30m/2h/1d。
- 最大重试次数或最长重试窗口；超限进入死信。
- 支持人工或脚本重放。
- 外部系统长期不可用：任务保持失败态，持续退避重试并告警。

幂等性：
- 支持业务方传入 idempotency_key（如订单号），系统只保证“至少一次”；业务方或供应商需自行处理幂等。

## 5. 取舍与演进
### 5.1 未采纳的“过度设计”示例
- 全量分布式事务/精确一次：复杂度高，收益有限。
- 复杂工作流编排引擎：第一版不需要。
- 多区域多活与流量调度：超出当前规模。

### 5.2 取舍对比（DB vs Redis vs Kafka）
- 关系型数据库 + 扫描：实现简单、易运维，适合第一版；缺点是吞吐与延迟精度有限。
- Redis 延迟队列：实现成本适中，提升吞吐与调度精度；但需要额外运维与数据一致性处理。
- Kafka：适合高吞吐事件流，但延迟重试/调度需要额外编排组件；本场景第一版会引入不必要复杂度。

### 5.3 未来演进方向
- 高吞吐：引入 Redis 作为延迟队列/轻量队列，配合水平扩展投递执行器。
- 多租户隔离：按业务系统/供应商维度限流与隔离。
- 配置化模板：供应商请求头/请求体模板、签名机制、重试策略可配置。
- 可视化运营：任务追踪、失败重放、告警与 SLA 报表。

## 6. 中间件选择与替代方案
本次 MVP 选择“数据库任务表 + 定时扫描”，原因是实现简单、交付快、可控性高，足以覆盖当前规模与可靠性需求。

不选 MQ（如 Kafka）的原因：未来实现延迟调度与编排复杂度高，不符当前模块的定位；未来流量增大时优先考虑 Redis 延迟队列。

第一版可选：
- 轻量方案：关系型数据库任务表 + 轮询/定时扫描（MVP 快速验证）。

演进方向：
- 流量增长时引入 Redis 作为延迟队列/任务队列，提高吞吐与调度精度。

备选但不优先：
- Kafka：用于超高吞吐与跨系统事件流时可考虑；当前阶段会增加编排与延迟调度复杂度。

## 7. 代码实现说明
本仓库的实现以 MVP 为目标，覆盖：
- API 接收与任务落库。
- 简单队列或定时器驱动的投递执行。
- 失败重试与状态记录。

## 8. AI 使用说明
AI 参与内容：
- 需求要点梳理、架构草图、可靠性策略建议、取舍清单。

未采纳建议：
- 立即引入复杂的编排引擎或分布式事务。
- 在第一版加入完整的运营后台。
- 设计过细的退避策略与调度配置：MVP 直接使用 `spring-retry` 即可，后续再做可配置化与调度精细化。

关键自主决策：
- 选择至少一次投递语义，理由是可靠性与实现复杂度的平衡。
- MVP 优先使用简单队列/数据库扫描方案，降低系统复杂度与开发时间。
